mds_df <- data.frame(sample = rownames(mds),
X1 = mds[,1],
X2 = mds[,2])
}
# merge mds and pheno
mds_pheno <- merge(mds_df, za_pheno, by = "sample", all.x = T)
mds_pheno$site[is.na(mds_pheno$site)] <- "Reference"
mds_pheno$site <- factor(mds_pheno$site,
levels = c("Bushbuckridge", "Soweto", "Reference"))
# no labels
g <- ggplot(mds_pheno, aes(X1, X2, color = site)) +
geom_point(size = 1, alpha = 0.85) +
labs(x = ifelse(nmds, "NMDS 1", "MDS 1"),
y = ifelse(nmds, "NMDS 2", "MDS 2"),
color = "",
title = plot_title) +
theme_cowplot() +
background_grid() +
scale_color_manual(values = c(za_pal, "#DDDDDD")) +
theme(legend.position = "bottom",
legend.justification = "center",
plot.title = element_text(face = "italic")) +
coord_fixed()
if (!legend) g <- g + theme(legend.position = "none")
return(g)
}
## panphlan plots ----
sp <- c("Prevotella_copri",
"Faecalibacterium_prausnitzii",
"Bacteroides_vulgatus",
"Eubacterium_siraeum",
"Alistipes_putredinis",
"Butyrivibrio_crossotus")
plots <- list()
for (org in sp){
infile <- here(paste0("input_final/panphlan_v2/", org,
"_profile_sensitive.txt"))
p <- plot_panphlan(infile, nmds = F, plot_title = gsub("_", " ", org))
plots[[org]] <- p
}
a <- plot_grid(plotlist = plots, ncol = 2)
## adonis
adonis_res <- data.frame()
sp <- c("Prevotella_copri",
"Faecalibacterium_prausnitzii",
"Bacteroides_vulgatus",
"Eubacterium_siraeum",
"Alistipes_putredinis",
"Butyrivibrio_crossotus")
a
plots <- list()
for (org in sp){
infile <- here(paste0("input_final/panphlan_v2/", org,
"_profile_sensitive.txt"))
legend_flag <- ifelse(org == "Prevotella_copri", T, F)
p <- plot_panphlan(infile, nmds = F,
plot_title = gsub("_", " ", org), legend = legend_flag)
plots[[org]] <- p
}
a <- plot_grid(plotlist = plots, ncol = 2)
a
# function to ordinate and plot panphlan results table
plot_panphlan <- function(panphlan_f, nmds = T, plot_title = "", legend = F){
# read panphlan pangenome matrix
panphlan <- read.table(panphlan_f, sep = "\t", header = T, row.names = 1, quote = "")
colnames(panphlan) <- gsub('.tsv', '', colnames(panphlan))
# filter for relevant samples
panphlan <- panphlan[, which(names(panphlan) %in% za_pheno$sample |
grepl("REF", names(panphlan)))]
# calculate jaccard distance
panphlan_t <- t(panphlan)
dist_matrix <- vegdist(panphlan_t, method = "jaccard", binary = T)
# colnames(dist_matrix) <- colnames(panphlan)
# ordinate
if (nmds){
# default nmds
vare_mds0 <- isoMDS(dist_matrix)
mds_df <- data.frame(vare_mds0$points)
mds_df$sample <- row.names(mds_df)
} else {
# calculate pcoa/mds
mds <- cmdscale(dist_matrix)
mds_df <- data.frame(sample = rownames(mds),
X1 = mds[,1],
X2 = mds[,2])
}
# merge mds and pheno
mds_pheno <- merge(mds_df, za_pheno, by = "sample", all.x = T)
mds_pheno$site[is.na(mds_pheno$site)] <- "Reference"
mds_pheno$site <- factor(mds_pheno$site,
levels = c("Bushbuckridge", "Soweto", "Reference"))
# no labels
g <- ggplot(mds_pheno, aes(X1, X2, color = site)) +
geom_point(size = 1, alpha = 0.85) +
labs(x = ifelse(nmds, "NMDS 1", "MDS 1"),
y = ifelse(nmds, "NMDS 2", "MDS 2"),
color = "",
title = plot_title) +
theme_cowplot() +
background_grid() +
scale_color_manual(values = c(za_pal, "#DDDDDD")) +
theme(legend.position = "top",
legend.justification = "center",
plot.title = element_text(face = "italic")) +
coord_fixed()
if (!legend) g <- g + theme(legend.position = "none")
return(g)
}
## panphlan plots ----
sp <- c("Prevotella_copri",
"Faecalibacterium_prausnitzii",
"Bacteroides_vulgatus",
"Eubacterium_siraeum",
"Alistipes_putredinis",
"Butyrivibrio_crossotus")
plots <- list()
for (org in sp){
infile <- here(paste0("input_final/panphlan_v2/", org,
"_profile_sensitive.txt"))
legend_flag <- ifelse(org == "Prevotella_copri", T, F)
p <- plot_panphlan(infile, nmds = F,
plot_title = gsub("_", " ", org), legend = legend_flag)
plots[[org]] <- p
}
a <- plot_grid(plotlist = plots, ncol = 2)
## adonis
adonis_res <- data.frame()
# sp <- c("Prevotella_copri",
#         "Faecalibacterium_prausnitzii",
#         "Bacteroides_vulgatus",
#         "Eubacterium_siraeum",
#         "Alistipes_putredinis",
#         "Butyrivibrio_crossotus")
for (org in sp){
panphlan_f <- here(paste0("input_final/panphlan_v2/", org,
"_profile_sensitive.txt"))
# read panphlan pangenome matrix
panphlan <- read.table(panphlan_f, sep = "\t", header = T, row.names = 1, quote = "")
colnames(panphlan) <- gsub('.tsv', '', colnames(panphlan))
# metadata
meta <- za_pheno %>%
filter(sample %in% names(panphlan))
# filter for relevant samples
panphlan <- panphlan[, meta$sample]
# calculate jaccard distance
panphlan_t <- t(panphlan)
dist_matrix <- vegdist(panphlan_t, method = "jaccard", binary = T)
ad <- adonis(dist_matrix~site, meta)
adonis_res <- rbind(adonis_res,
data.frame("Species" = org,
"R2" = ad$aov.tab$R2[1],
"pvalue" = ad$aov.tab$`Pr(>F)`[1]))
}
b <- adonis_res %>%
mutate(R2 = round(R2, 3),
FDR = p.adjust(pvalue, method = "fdr")) %>%
ggtexttable(rows = NULL, cols = c("Species", "R2", "P value", "FDR"), theme =
ttheme("classic", base_size = 12, padding = unit(c(4, 4), "mm")))
plot_grid(a, b)
ggsave(here("final_plots/supplementary/figure_SN_panphlan.png"),
width = 10, height = 10)
a <- plot_grid(plotlist = plots, ncol = 3)
plot_grid(a, b)
ggsave(here("final_plots/supplementary/figure_SN_panphlan.png"),
width = 10, height = 10)
a
plot_grid(a, b)
ggsave(here("final_plots/supplementary/figure_SN_panphlan.png"),
width = 10, height = 10)
a
# function to ordinate and plot panphlan results table
plot_panphlan <- function(panphlan_f, nmds = T, plot_title = "", legend = F){
# read panphlan pangenome matrix
panphlan <- read.table(panphlan_f, sep = "\t", header = T, row.names = 1, quote = "")
colnames(panphlan) <- gsub('.tsv', '', colnames(panphlan))
# filter for relevant samples
panphlan <- panphlan[, which(names(panphlan) %in% za_pheno$sample |
grepl("REF", names(panphlan)))]
# calculate jaccard distance
panphlan_t <- t(panphlan)
dist_matrix <- vegdist(panphlan_t, method = "jaccard", binary = T)
# colnames(dist_matrix) <- colnames(panphlan)
# ordinate
if (nmds){
# default nmds
vare_mds0 <- isoMDS(dist_matrix)
mds_df <- data.frame(vare_mds0$points)
mds_df$sample <- row.names(mds_df)
} else {
# calculate pcoa/mds
mds <- cmdscale(dist_matrix)
mds_df <- data.frame(sample = rownames(mds),
X1 = mds[,1],
X2 = mds[,2])
}
# merge mds and pheno
mds_pheno <- merge(mds_df, za_pheno, by = "sample", all.x = T)
mds_pheno$site[is.na(mds_pheno$site)] <- "Reference"
mds_pheno$site <- factor(mds_pheno$site,
levels = c("Bushbuckridge", "Soweto", "Reference"))
# no labels
g <- ggplot(mds_pheno, aes(X1, X2, color = site)) +
geom_point(size = 1, alpha = 0.85) +
labs(x = ifelse(nmds, "NMDS 1", "MDS 1"),
y = ifelse(nmds, "NMDS 2", "MDS 2"),
color = "",
title = plot_title) +
theme_cowplot() +
background_grid() +
scale_color_manual(values = c(za_pal, "#DDDDDD")) +
theme(legend.position = "top",
legend.justification = "center",
plot.title = element_text(face = "italic"))
# coord_fixed()
if (!legend) g <- g + theme(legend.position = "none")
return(g)
}
## panphlan plots ----
sp <- c("Prevotella_copri",
"Faecalibacterium_prausnitzii",
"Bacteroides_vulgatus",
"Eubacterium_siraeum",
"Alistipes_putredinis",
"Butyrivibrio_crossotus")
plots <- list()
for (org in sp){
infile <- here(paste0("input_final/panphlan_v2/", org,
"_profile_sensitive.txt"))
legend_flag <- ifelse(org == "Prevotella_copri", T, F)
p <- plot_panphlan(infile, nmds = F,
plot_title = gsub("_", " ", org), legend = legend_flag)
plots[[org]] <- p
}
a <- plot_grid(plotlist = plots, ncol = 3)
## adonis
adonis_res <- data.frame()
# sp <- c("Prevotella_copri",
#         "Faecalibacterium_prausnitzii",
#         "Bacteroides_vulgatus",
#         "Eubacterium_siraeum",
#         "Alistipes_putredinis",
#         "Butyrivibrio_crossotus")
for (org in sp){
panphlan_f <- here(paste0("input_final/panphlan_v2/", org,
"_profile_sensitive.txt"))
# read panphlan pangenome matrix
panphlan <- read.table(panphlan_f, sep = "\t", header = T, row.names = 1, quote = "")
colnames(panphlan) <- gsub('.tsv', '', colnames(panphlan))
# metadata
meta <- za_pheno %>%
filter(sample %in% names(panphlan))
# filter for relevant samples
panphlan <- panphlan[, meta$sample]
# calculate jaccard distance
panphlan_t <- t(panphlan)
dist_matrix <- vegdist(panphlan_t, method = "jaccard", binary = T)
ad <- adonis(dist_matrix~site, meta)
adonis_res <- rbind(adonis_res,
data.frame("Species" = org,
"R2" = ad$aov.tab$R2[1],
"pvalue" = ad$aov.tab$`Pr(>F)`[1]))
}
b <- adonis_res %>%
mutate(R2 = round(R2, 3),
FDR = p.adjust(pvalue, method = "fdr")) %>%
ggtexttable(rows = NULL, cols = c("Species", "R2", "P value", "FDR"), theme =
ttheme("classic", base_size = 12, padding = unit(c(4, 4), "mm")))
plot_grid(a, b)
ggsave(here("final_plots/supplementary/figure_SN_panphlan.png"),
width = 10, height = 10)
plot_grid(a, b, ncol = 2, labels = c("A", "B"))
ggsave(here("final_plots/supplementary/figure_SN_panphlan.png"),
width = 10, height = 10)
b <- adonis_res %>%
mutate(R2 = round(R2, 3),
FDR = p.adjust(pvalue, method = "fdr"),
Species = gsub("_", "", Species)) %>%
ggtexttable(rows = NULL, cols = c("Species", "R2", "P value", "FDR"), theme =
ttheme("classic", base_size = 12, padding = unit(c(4, 4), "mm")))
plot_grid(a, b, ncol = 1, labels = c("A", "B"))
ggsave(here("final_plots/supplementary/figure_SN_panphlan.png"),
width = 10, height = 10)
a <- plot_grid(plotlist = plots, ncol = 3, align = "hv", axis = "lrbt")
a
for (org in sp){
infile <- here(paste0("input_final/panphlan_v2/", org,
"_profile_sensitive.txt"))
# legend_flag <- ifelse(org == "Prevotella_copri", T, F)
p <- plot_panphlan(infile, nmds = F,
plot_title = gsub("_", " ", org), legend = F)
plots[[org]] <- p
}
legend <- get_legend(p + theme(legend.position = "top"))
legend <- get_legend(p + theme(legend.position = "top"))
a1 <- plot_grid(plotlist = plots, ncol = 3, align = "hv", axis = "lrbt")
a <- plot_grid(a1, legend, ncol = 1, rel_heights = c(0.95, 0.05))
a
plot_grid(a, b, ncol = 1, labels = c("A", "B"))
ggsave(here("final_plots/supplementary/figure_SN_panphlan.png"),
width = 10, height = 10)
plot_grid(a, b, ncol = 1, labels = c("A", "B"), rel_heights = c(0.6, 0.4))
ggsave(here("final_plots/supplementary/figure_SN_panphlan.png"),
width = 10, height = 8)
plot_grid(a, b, ncol = 1, labels = c("A", "B"), rel_heights = c(0.7, 0.3))
ggsave(here("final_plots/supplementary/figure_SN_panphlan.png"),
width = 10, height = 8)
b <- adonis_res %>%
mutate(R2 = round(R2, 3),
FDR = p.adjust(pvalue, method = "fdr"),
Species = gsub("_", " ", Species)) %>%
ggtexttable(rows = NULL, cols = c("Species", "R2", "P value", "FDR"), theme =
ttheme("classic", base_size = 12, padding = unit(c(4, 4), "mm")))
plot_grid(a, b, ncol = 1, labels = c("A", "B"), rel_heights = c(0.7, 0.3))
ggsave(here("final_plots/supplementary/figure_SN_panphlan.png"),
width = 10, height = 8)
# plot table of conmeds and categories
library(cowplot)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(vegan)
### conmeds data table
conmeds <- read.table(here("input_final/conmeds.tsv"), sep = "\t",
header = T, quote = "")
head(conmeds)
### conmeds data table
conmeds <- read.table(here("input_final/conmeds.tsv"), sep = "\t",
header = T, quote = "")
conmeds <- conmeds %>%
filter(!(medicine_CURATED %in% c("", "??", "NONE", "UNKNOWN")))
dim(conmeds)
head(conmeds)
length(unique(conmeds$sample))
za_meta <- readRDS(here("rds/za_meta.rds"))
setdiff(za_meta$sample, unique(conmeds$sample))
za_pheno
m <- setdiff(za_meta$sample, unique(conmeds$sample))
za_pheno %>% filter(sample %in% m) %>% select(sample, medication, medication_reason)
za_pheno %>% filter(sample %in% m) %>% dplyr::select(sample, medication, medication_reason)
za_pheno %>% filter(sample %in% m) %>% dplyr::select(sample, medication, medication_reason) %>% View()
18/118
## load data ----
source(here("scripts/load_data.R"))
labs <- read.table(here("input_final/za_labels.tsv"), sep = "\t", header = T)
## readcounts ----
## read PAIRS
za_readcounts <- read.table(here("input_final", "readcounts",
"za_readcounts_preprocessing.txt"),
sep = '\t', header = T)
# read PAIRS -- multiply by 2
# filter out extra samples
za_counts <- za_readcounts %>%
filter(Sample %in% za_meta$sample) %>%
mutate(raw_reads = raw_reads * 2,
trimmed_reads = trimmed_reads * 2,
dedup_reads = dedup_reads * 2,
host_removed_reads = host_removed_reads * 2,
orphan_reads = orphan_reads * 2
) %>%
dplyr::select(-starts_with("orphan"), -ends_with("frac"))
# za_counts <- za_readcounts[, c(1:3, 5, 7)]
## stats for intro
za_counts %>%
mutate(
Gb_raw = raw_reads * 150 / 1e9,
Gb_preproc = host_removed_reads * 150 / 1e9
) %>%
summarise(
median_gb_raw = median(Gb_raw),
median_gb_raw = median(Gb_raw),
mean_gb_preproc = mean(Gb_preproc)
)
za_counts
paste(c(1, 3))
## stats for intro
za_counts %>%
mutate(
Gb_raw = raw_reads * 150 / 1e9,
Gb_preproc = host_removed_reads * 150 / 1e9
) %>%
summarise(
median_reads_raw = median(raw_reads),
median_reads_preproc = median(host_removed_reads),
range_reads_raw = paste(range(raw_reads)),
range_reads_preproc = paste(range(host_removed_reads)),
median_gb_raw = median(Gb_raw),
median_gb_raw = median(Gb_raw),
mean_gb_preproc = mean(Gb_preproc)
)
paste(range(za_counts$raw_reads))
## stats for intro
za_counts %>%
mutate(
Gb_raw = raw_reads * 150 / 1e9,
Gb_preproc = host_removed_reads * 150 / 1e9
) %>%
summarise(
median_reads_raw = median(raw_reads),
median_reads_preproc = median(host_removed_reads),
range_reads_raw = paste(range(raw_reads), collapse = T),
range_reads_preproc = paste(range(host_removed_reads), collapse = T),
median_gb_raw = median(Gb_raw),
median_gb_raw = median(Gb_raw),
mean_gb_preproc = mean(Gb_preproc)
)
## stats for intro
za_counts %>%
mutate(
Gb_raw = raw_reads * 150 / 1e9,
Gb_preproc = host_removed_reads * 150 / 1e9
) %>%
summarise(
median_reads_raw = median(raw_reads),
median_reads_preproc = median(host_removed_reads),
range_reads_raw = paste(range(raw_reads), collapse = " "),
range_reads_preproc = paste(range(host_removed_reads), collapse = " "),
median_gb_raw = median(Gb_raw),
median_gb_raw = median(Gb_raw),
mean_gb_preproc = mean(Gb_preproc)
)
za_counts %>%
mutate(
Gb_raw = raw_reads * 150 / 1e9,
Gb_preproc = host_removed_reads * 150 / 1e9
) %>%
summarise(
median_reads_raw = median(raw_reads) / 1e6,
median_reads_preproc = median(host_removed_reads) / 1e6,
range_reads_raw = paste(range(raw_reads), collapse = " ") / 1e6,
range_reads_preproc = paste(range(host_removed_reads), collapse = " ") / 1e6,
median_gb_raw = median(Gb_raw),
median_gb_raw = median(Gb_raw),
mean_gb_preproc = mean(Gb_preproc)
)
## stats for intro
za_counts %>%
mutate(
Gb_raw = raw_reads * 150 / 1e9,
Gb_preproc = host_removed_reads * 150 / 1e9
) %>%
summarise(
median_reads_raw = median(raw_reads) / 1e6,
median_reads_preproc = median(host_removed_reads) / 1e6,
range_reads_raw = paste(range(raw_reads) / 1e6, collapse = " "),
range_reads_preproc = paste(range(host_removed_reads) / 1e6, collapse = " "),
median_gb_raw = median(Gb_raw),
median_gb_raw = median(Gb_raw),
mean_gb_preproc = mean(Gb_preproc)
)
## stats for intro
za_counts %>%
mutate(
Gb_raw = raw_reads * 150 / 1e9,
Gb_preproc = host_removed_reads * 150 / 1e9
) %>%
summarise(
median_reads_raw = median(raw_reads) / 1e6,
median_reads_preproc = median(host_removed_reads) / 1e6,
range_reads_raw = paste(range(raw_reads) / 1e6, collapse = " "),
range_reads_preproc = paste(range(host_removed_reads) / 1e6, collapse = " "),
median_gb_raw = median(Gb_raw),
median_gb_raw = median(Gb_raw),
mean_gb_preproc = mean(Gb_preproc)
) %>%
mutate(across(where(is.numeric), ~round(., 3)))
labs <- read.table(here("input_final/za_labels.tsv"), sep = "\t", header = T)
## readcounts ----
## read PAIRS
za_readcounts <- read.table(here("input_final", "readcounts",
"za_readcounts_preprocessing.txt"),
sep = '\t', header = T)
# read PAIRS -- multiply by 2
# filter out extra samples
za_counts <- za_readcounts %>%
filter(Sample %in% za_meta$sample) %>%
mutate(raw_reads = raw_reads * 2,
trimmed_reads = trimmed_reads * 2,
dedup_reads = dedup_reads * 2,
host_removed_reads = host_removed_reads * 2,
orphan_reads = orphan_reads * 2
) %>%
dplyr::select(-starts_with("orphan"), -ends_with("frac"))
# za_counts <- za_readcounts[, c(1:3, 5, 7)]
## stats for intro
za_counts %>%
mutate(
Gb_raw = raw_reads * 150 / 1e9,
Gb_preproc = host_removed_reads * 150 / 1e9
) %>%
summarise(
median_reads_raw = median(raw_reads) / 1e6,
median_reads_preproc = median(host_removed_reads) / 1e6,
range_reads_raw = paste(range(raw_reads) / 1e6, collapse = " "),
range_reads_preproc = paste(range(host_removed_reads) / 1e6, collapse = " "),
median_gb_raw = median(Gb_raw),
median_gb_raw = median(Gb_raw),
mean_gb_preproc = mean(Gb_preproc)
) %>%
mutate(across(where(is.numeric), ~round(., 3)))
## A) MDS ordination ----
# find bray-curtis distance with vegdist
# vare_dis <- vegdist(t(za_S_rel), method = "bray")
vare_dis <- vegdist(t(za_S_css), method = "bray")
# adonis
meta <- za_meta %>% filter(sample %in% names(za_S_rel))
meta <- meta[match(names(za_S_rel), meta$sample), ]
adonis(vare_dis ~ site, data = meta)
dispersion <- betadisper(vare_dis, group = meta$site)
permutest(dispersion)
sample_meta
za_meat
za_meta
